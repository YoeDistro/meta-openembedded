From 74e2783ea44c4d69798ed72057e4e092b3f52f37 Mon Sep 17 00:00:00 2001
From: Khem Raj <raj.khem@gmail.com>
Date: Thu, 12 Nov 2020 20:04:09 -0800
Subject: [PATCH] Remove assumption on native compile

OE does a cross build, therefore all assumption on building for same
target as build should be addressed and proper cross compile values
should be used

Signed-off-by: Khem Raj <raj.khem@gmail.com>
---
 Makefile.in | 45 ++++++++++++++++++++++-----------------------
 configure   | 52 +++++++++-------------------------------------------
 2 files changed, 31 insertions(+), 66 deletions(-)

diff --git a/Makefile.in b/Makefile.in
index 5cccbdd..cb7c7b9 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -1,15 +1,15 @@
-# $smu-mark$ 
-# $name: Makefile.in$ 
-# $author: Salvatore Sanfilippo 'antirez'$ 
-# $copyright: Copyright (C) 1999 by Salvatore Sanfilippo$ 
-# $license: This software is under GPL version 2 of license$ 
-# $date: Sun Jul 25 17:56:15 MET DST 1999$ 
-# $rev: 3$ 
+# $smu-mark$
+# $name: Makefile.in$
+# $author: Salvatore Sanfilippo 'antirez'$
+# $copyright: Copyright (C) 1999 by Salvatore Sanfilippo$
+# $license: This software is under GPL version 2 of license$
+# $date: Sun Jul 25 17:56:15 MET DST 1999$
+# $rev: 3$
 
-CC= gcc
-AR=/usr/bin/ar
-RANLIB=/usr/bin/ranlib
-CCOPT= -O2 -Wall @PCAP_INCLUDE@ @TCL_INC@ @USE_TCL@
+CC?= gcc
+AR?=/usr/bin/ar
+RANLIB?=/usr/bin/ranlib
+CCOPT= -O2 -Wall @PCAP_INCLUDE@ @TCL_INC@ @USE_TCL@ ${CFLAGS}
 DEBUG= -g
 #uncomment the following if you need libpcap based build under linux
 #(not raccomanded)
@@ -50,14 +50,11 @@ libars.a: $(ARSOBJ)
 	$(RANLIB) $@
 
 hping3: byteorder.h $(OBJ)
-	$(CC) -o hping3 $(CCOPT) $(DEBUG) $(OBJ) -L/usr/local/lib $(PCAP) @SOLARISLIB@ @TCL_LIB@
+	$(CC) -o hping3 $(CCOPT) $(LDFLAGS) $(DEBUG) $(OBJ) $(PCAP) @SOLARISLIB@ @TCL_LIB@
 	@echo
-	./hping3 -v
-	@echo "use \`make strip' to strip hping3 binary"
-	@echo "use \`make install' to install hping3"
 
 hping3-static: byteorder.h $(OBJ)
-	$(CC) -static -o hping3-static $(CCOPT) $(DEBUG) $(OBJ) -L/usr/local/lib $(PCAP) @SOLARISLIB@ @TCL_LIB@ -ldl
+	$(CC) -static -o hping3-static $(CCOPT) $(DEBUG) $(OBJ) $(PCAP) @SOLARISLIB@ @TCL_LIB@ -ldl
 
 byteorder.h:
 	./configure
@@ -72,16 +69,18 @@ distclean:
 	rm -rf hping3 *.o byteorder byteorder.h systype.h Makefile libars.a .depend
 
 install: hping3
-	cp -f hping3 /usr/sbin/
-	chmod 755 /usr/sbin/hping3
-	ln -s /usr/sbin/hping3 /usr/sbin/hping
-	ln -s /usr/sbin/hping3 /usr/sbin/hping2
+	mkdir -p $(DESTDIR)/usr/sbin/
+	cp -f hping3 $(DESTDIR)/usr/sbin/
+	chmod 755 $(DESTDIR)/usr/sbin/hping3
+	ln -sf /usr/sbin/hping3 $(DESTDIR)/usr/sbin/hping
+	ln -sf /usr/sbin/hping3 $(DESTDIR)/usr/sbin/hping2
 	@if [ -d ${INSTALL_MANPATH}/man8 ]; then \
-		cp ./docs/hping3.8 ${INSTALL_MANPATH}/man8; \
-		chmod 644 ${INSTALL_MANPATH}/man8/hping3.8; \
+		mkdir -p $(DESTDIR)${INSTALL_MANPATH}/man8; \
+		cp -f ./docs/hping3.8 $(DESTDIR)${INSTALL_MANPATH}/man8; \
+		chmod 644 $(DESTDIR)${INSTALL_MANPATH}/man8/hping3.8; \
 	else \
 		echo "@@@@@@ WARNING @@@@@@"; \
-		echo "Can't install the man page: ${INSTALL_MANPATH}/man8 does not exist"; \
+		echo "Can't install the man page: $(DESTDIR)${INSTALL_MANPATH}/man8 does not exist"; \
 	fi
 
 strip: hping3
diff --git a/configure b/configure
index dab04ab..e0aaccb 100755
--- a/configure
+++ b/configure
@@ -16,14 +16,13 @@ fi
 CC=${CC:=cc}
 
 echo build byteorder.c...
-$CC byteorder.c -o byteorder || exit 1
+$CC ${CFLAGS} byteorder.c -o byteorder || exit 1
 
 INSTALL_MANPATH=`echo $MANPATH|cut -f1 -d:`
 if [ "$INSTALL_MANPATH" = "" ]; then
-	INSTALL_MANPATH="/usr/local/man"
+	INSTALL_MANPATH="/usr/share/man"
 fi
-BYTEORDER=`./byteorder -m`
-
+BYTEORDER=${BYTEORDER:=`./byteorder -m`}
 echo create byteorder.h...
 cat > byteorder.h <<EOF
 #ifndef __BYTEORDER_H
@@ -38,7 +37,6 @@ cat >> byteorder.h <<EOF
 #endif /* __BYTEORDER_H */
 EOF
 
-CONFIGOSTYPE=`uname -s | tr [a-z] [A-Z]`
 if [ ! "$CONFIGOSTYPE" ]; then
 	CONFIGOSTYPE=UNKNOWN
 fi
@@ -61,46 +59,14 @@ esac
 #
 # TCL detection
 #
-for TCLPATH_TRY in "/usr/bin/" "/usr/local/bin/" "/bin/"
-do
-	for TCLVER_TRY in "8.4" "8.3" "8.2" "8.1" "8.0"
-	do
-		if [ -z $TCLSH ]
-		then
-			TCLSH_TRY=${TCLPATH_TRY}tclsh${TCLVER_TRY}
-			if [ -f $TCLSH_TRY ]
-			then
-				TCLSH=$TCLSH_TRY
-				echo "===> Found Tclsh in: $TCLSH"
-			fi
-		fi
-	done
-done
-if [ -f $TCLSH ]
-then
-	TCL_VER=`echo puts \\$tcl_version | $TCLSH -`
-	USE_TCL='-DUSE_TCL'
-	TCL_LIB="-ltcl${TCL_VER}"
-	if [ -e /usr/include/tcl${TCL_VER} ]
-	then
-		TCL_INC="-I/usr/include/tcl${TCL_VER}"
-	elif [ -e /usr/include/tcl.h ]
-	then
-		TCL_INC=""
-	elif [ -e /usr/local/include/tcl${TCL_VER} ]
-	then
-		TCL_INC="-I/usr/local/include/tcl${TCL_VER}"
-	else
-		USE_TCL=""
-		TCL_LIB=""
-		echo "==> WARNING: no Tcl header files found!"
-	fi
-fi
-if [ -n $USE_TCL ]
+
+TCL_VER=`pkg-config --modversion tcl | sed 's/\(.*\)\..*/\1/'`
+if [ -n $TCL_VER ]
 then
-	LIBPOSTFIX=`ls -1 /usr/local/lib/ /usr/lib | grep 'libtcl[0-9]' | grep so | sed -e 's/\.so.*//g' -e 's/libtcl//g' | sort -r | head -1`
-	TCL_LIB="-ltcl${LIBPOSTFIX} -lm -lpthread"
+  USE_TCL='-DUSE_TCL'
 fi
+TCL_LIB="`pkg-config --libs tcl` -lm -lpthread"
+TCL_INC="-I=/usr/include/tcl${TCL_VER}"
 
 #
 # configurable stuff
